= DESCRIPTION:

The AWS LWRP gives control of Amazon Web Services (AWS) Elastic Block Store (EBS) and Elastic IP. They are pretty much separate sets of AWS capability and only share the AWS configuration information.

All the following actions are operating on the current EC2 Instance that is running the recipe that is calling this resource.

= REQUIREMENTS:

= ATTRIBUTES: 

== ebs_volume

* :aws_access_key				Your Amazon Web Services Key
* :aws_secret_access_key		Your Amazon Web Services Secret Access Key
* :size							Size in MB of the EBS Volume to create
* :snapshot_id					EBS Snapshot IT used to specify snapshot for create or snapshoting
* :availability_zone			AWS Availability Zone (us-east-1a, us-east-1b, us-west-1a, etc.)
* :device						EC2 Instance Linux Device path (/dev/sda thru /dev/sdp) to attach to
* :volume_id					EBS Volume ID used for attach, detach or snapshotting
* :timeout		               	Time to wait before declaring operation failed Default is3 mins, nil or 0 for no timeout

== elastic_ip

* :aws_access_key				Your Amazon Web Services Key
* :aws_secret_access_key		Your Amazon Web Services Secret Access Key
* :ip							Elastic IP Address to associate or disassociate with the current EC2 Instance
* :timeout		               	Time to wait before declaring operation failed Default is3 mins, nil or 0 for no timeout

= USAGE:

== ebs_volume actions

All actions must specify :aws_access_key and :aws_secret_access_key

=== Create an attachable EBS Volume Instance
==== :create 

===== Required attributes

* :size
* :availability_zone

===== Optional attributes

* :snapshot_id
* :timeout

===== Description

It will create a new volume if :volume_id is NOT set. The new volume will be set to :size and :availability_zone. 

If  :snapshot_id is set, the specified snapshot will be used to create the EBS Volume Instance. The specified snapshot must have the same size and availability zone as specified by the attributes.

If a volume is already associated with this resource from an early attach, the call will raise an exception if the already attached node is not the same :size or :availability_zone as requested. 

It will NOT raise and exception if it is an attempt to reattach an already attached volume that meets the :size and :availability_zone

=== Attach an EBS Volume Instance to the current EC2 instance
==== :attach 

===== Required attributes

* :volume_id
* :device

===== Optional attributes

* :timeout

===== Description

Attaches the EBS Volume Instance specified by :volume_id or the one previously set up by a :create call to the Linux Device path specified by :device for the current EC2 Instance

An exception is raised if the volume_id is already attached to another EC2 instance.

=== Detach an EBS Volume Instance from current EC2 Instance
==== :detatch

===== Required attributes

* :volume_id

===== Optional attributes

* :timeout

===== Description

Detaches an already attached EBS Volume Instance from the current EC2 Instance. The volume can be specified by :volume_id or to an already attached volume

Will do nothing if the specified :volume_id is not attached to the current EC2 instance

=== Create an EBS snapshot of EBS Volume
==== :snapshot

===== Required attributes

* :volume_id

===== Description

Make an EBS snapsot of an EBS Volume specified by :volume_id

== elastic_ip actions

=== Associate an Elastic IP to the Currrent EC2 instance
==== :associate

===== Required attributes

* :ip

===== Description

Associate an AWS Elastic IP address with the current EC2 instance. 

The Elastic IP address has to have been previously  allocated from AWS to your account (specified by the :aws_access_key). You will have to use the ec2-tools, elasticfox or some other ec2 management tool to get the IP. This LWRP does not have an action to request an IP address.

=== Disassociate an Elastic IP to this instance
==== :disassociate

===== Required attributes

* :ip

===== Description

This function will disassociate and free up the Elastic IP address specified by :ip. Once its disassociated, it can be used again via the :associate action or by another EC2 instance.

= Examples

== Using aws:ebs_volume

=== Doing a simple attach

The following creates a resource called "mysql_data_volume" that will attach an EBS Volume with the ID "vol-5ebf7b06". It won't run if something is already mounted on /dev/sdh.

Code:

  aws_ebs_volume "mysql_data_volume" do
    aws_access_key "0ZV2L5PE74WQJAGRGK95"
    aws_secret_access_key "9c+JKLh1bX3bQns0igv2ETvMlvVJTAR+laazwk38"
    volume_id "vol-5ebf7b06"
    availability_zone "us-east-1a"
    device "/dev/sdh"
    action :attach
    provider "aws_ebs_volume"
    not_if "mount | grep "/dev/sdh"
  end

=== Create and attache several EBS volumes, create xfs filesystems and mount each filesystem

This assumes that you have passed in the  attributes:
* aws_access_key: Your Amazon Access Key
* aws_secret_access_key: Your Amazon Secret Access Key

* ebs[:volumes]: An array of hashes. Each hash has the following keys:
  - mount_point: The already created directory in the node's filesystem that we will mount the volume on
  - size: The Size of the volume to create
  - device: The system device (/dev/sdh for example) that the volume will be attached

Code:

  node[:ebs][:volumes].each do |vol|

    aws_ebs_volume "sized: #{vol[:size]}GB device: #{vol[:device]} on #{vol[:mount_point]}  data_volume" do
      aws_access_key node[:aws_access_key]
      aws_secret_access_key node[:aws_secret_access_key]
      availability_zone node[:runa][:availability_zone]
      device "#{vol[:device]}"
      size vol[:size]
      action [:create, :attach]
      provider "aws_ebs_volume"
      not_if "mount | grep \"#{vol[:mount_point]}\""
    end

    bash "creating xfs filesystem for #{vol[:mount_point]} #{vol[:device]}" do
      code <<-EOH 
      mkfs.xfs #{vol[:device]}
      mkdir -p #{vol[:mount_point]}
      EOH
      not_if "mount | grep \"#{vol[:mount_point]}\""
    end

    mount "#{vol[:mount_point]}" do
      device "#{vol[:device]}"
      options "rw noatime"
      fstype "xfs"
      action [ :enable, :mount ]
      # Do not execute if its already mounted
      not_if "cat /proc/mounts | grep #{vol[:mount_point]}"
    end
  end
